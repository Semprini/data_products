name: ${DOMAIN}_Domain

services:

  postgres:
    image: pgvector/pgvector:pg17
    container_name: ${DOMAIN}-postgres
    networks:
      - domain_data_net
      - data_management_data_management_net
    ports:
      - "15432:5432"
    environment:
      PGDATA: /var/lib/postgresql/data
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./config/postgres/initdb:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5


  falkordb:
    image: falkordb/falkordb:latest
    container_name: ${DOMAIN}-falkordb
    networks:
      - domain_data_net
      - data_management_data_management_net
    ports:
      - "6379:6379" # Redis/FalkorDB port
      - "3200:3000" # FalkorDB web UI
    environment:
      - FALKORDB_PASSWORD=${FALKORDB_PASSWORD:-}
    volumes:
      - ./data/falkordb:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s


  graphiti-mcp:
    image: zepai/knowledge-graph-mcp:standalone
    container_name: ${DOMAIN}-graphiti-mcp
    networks:
      - domain_data_net
      - data_management_data_management_net
    ports:
      - "8000:8000"
    depends_on:
      falkordb:
        condition: service_healthy
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # Database configuration
      - FALKORDB_URI=${FALKORDB_URI:-redis://falkordb:6379}
      # - FALKORDB_PASSWORD=${FALKORDB_PASSWORD:-}
      # - FALKORDB_DATABASE=${FALKORDB_DATABASE:-default_db}
      # Application configuration
      - GRAPHITI_GROUP_ID=${GRAPHITI_GROUP_ID:-main}
      - SEMAPHORE_LIMIT=${SEMAPHORE_LIMIT:-10}
      - CONFIG_PATH=/app/mcp/config/config.yaml
      - PATH=/root/.local/bin:${PATH}
    volumes:
      # - ../config/config-docker-falkordb.yaml:/app/mcp/config/config.yaml:ro
      - ./data/graphiti/mcp_logs:/var/log/graphiti
    command: ["uv", "run", "main.py"]


  minio:
    image: minio/minio:latest
    container_name: ${DOMAIN}-minio
    networks:
      - domain_data_net
      - data_management_data_management_net
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address :9001
    environment:
      MINIO_ROOT_USER: ${MINIO_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD}
    volumes:
      - ./data/minio:/data
    healthcheck:
      test: ["CMD", "curl", "-I", "http://localhost:9000/minio/health/live"]
      interval: 5s
      retries: 5


  ducklake-init:
    build: ./ducklake-init
    container_name: ${DOMAIN}-ducklake-init
    networks:
      - domain_data_net
      - data_management_data_management_net
    environment:
      # Postgres catalog
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ducklake_catalog
      # S3 (MinIO) creds
      AWS_ACCESS_KEY_ID: ${MINIO_USER}
      AWS_SECRET_ACCESS_KEY: ${MINIO_PASSWORD}
      AWS_REGION: ap-southeast-2
      AWS_ENDPOINT_URL: http://minio:9000
      BUCKET: ducklake
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    volumes:
      - ./data/ducklake:/data


  kafka:
    image: apache/kafka:latest
    container_name: ${DOMAIN}-kafka
    networks:
      - domain_data_net
      - data_management_data_management_net
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://localhost:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3


  kafdrop:
    image: obsidiandynamics/kafdrop:latest
    container_name: ${DOMAIN}-kafdrop
    networks:
      - domain_data_net
      - data_management_data_management_net
    ports:
      - "9100:9000"
    environment:
      # KAFKA_BROKER_CONNECT: kafka:9092
      KAFKA_BROKERCONNECT: "kafka:9092"
      JVM_OPTS: "-Xms32M -Xmx64M"
    depends_on:
      - kafka


networks:
  domain_data_net:
    name: ${DOMAIN}_data_net  
  data_management_data_management_net:
    external: true


volumes:
  postgres_data:
    driver: local
  falkordb_data:
    driver: local
  mcp_logs:
    driver: local
